import pg from "pg";
import { drizzle } from "drizzle-orm/node-postgres";
import * as schema from "../shared/schema";

async function seed() {
  const pool = new pg.Pool({ connectionString: process.env.DATABASE_URL });
  const db = drizzle(pool, { schema });

  // اگر قبلاً seed شده، محتوای آموزشی را پاک می‌کنیم و دوباره seed می‌زنیم
  const existingPaths = await db.select().from(schema.paths);
  if (existingPaths.length > 0) {
    console.log("Database already seeded. Clearing learning content and reseeding...");
    await db.delete(schema.userAchievements);
    await db.delete(schema.achievements);
    await db.delete(schema.projectSubmissions);
    await db.delete(schema.projects);
    await db.delete(schema.xpEvents);
    await db.delete(schema.streaks);
    await db.delete(schema.progress);
    await db.delete(schema.attempts);
    await db.delete(schema.exercises);
    await db.delete(schema.lessons);
    await db.delete(schema.skills);
    await db.delete(schema.paths);
  }

  const [path] = await db
    .insert(schema.paths)
    .values({
      title: "پایه‌های مالی شخصی",
      description:
        "مبانی مدیریت مالی شخصی را قدم‌به‌قدم یاد بگیر: بودجه‌بندی، پس‌انداز، مدیریت بدهی، اصول سرمایه‌گذاری و برنامه‌ریزی بلندمدت.",
      orderIndex: 0,
      iconName: "trending-up",
      colorHex: "#00B87C",
    })
    .returning();

  const skillsData = [
    {
      title: "مبانی بودجه‌بندی",
      description: "یاد بگیر درآمد و هزینه‌ها را رصد کنی، بودجه بسازی و به آن پایبند بمانی.",
      orderIndex: 0,
      iconName: "pie-chart",
    },
    {
      title: "پس‌انداز و صندوق اضطراری",
      description: "یک پشتوانه امن بساز و عادت‌های پس‌انداز پایدار ایجاد کن.",
      orderIndex: 1,
      iconName: "shield",
    },
    {
      title: "مبانی بدهی و اعتبار",
      description: "بفهم بدهی چگونه کار می‌کند، اعتبار را هوشمندانه مدیریت کن و برای تسویه برنامه‌ریزی کن.",
      orderIndex: 2,
      iconName: "credit-card",
    },
    {
      title: "مبانی سرمایه‌گذاری",
      description: "با سهام، اوراق بدهی، صندوق‌های شاخص و قدرت رشد مرکب آشنا شو.",
      orderIndex: 3,
      iconName: "bar-chart-2",
    },
    {
      title: "ریسک و برنامه‌ریزی بلندمدت",
      description: "ریسک مالی را مدیریت کن، برای بازنشستگی برنامه‌ریزی کن و اهداف بلندمدت تعیین کن.",
      orderIndex: 4,
      iconName: "target",
    },
  ];

  const insertedSkills = await db
    .insert(schema.skills)
    .values(skillsData.map((s) => ({ ...s, pathId: path.id })))
    .returning();

  const lessonsMap: Record<string, { title: string; content: any[] }[]> = {
    "مبانی بودجه‌بندی": [
      {
        title: "بودجه چیست؟",
        content: [
          { type: "read", text: "بودجه یک «نقشه راه» برای پول توست. بودجه به هر تومان می‌گوید کجا برود تا تو کنترل امور مالی‌ات را در دست داشته باشی، نه برعکس." },
          { type: "read", text: "بودجه را مثل نقشه مسیر تصور کن: بدون نقشه هم ممکن است به مقصد برسی، اما در راه زمان و انرژی (و پول) بیشتری هدر می‌دهی." },
        ],
      },
      {
        title: "درآمد در برابر هزینه",
        content: [
          { type: "read", text: "درآمد یعنی پولی که وارد می‌شود: حقوق، کار آزاد، پروژه‌های جانبی. هزینه یعنی پولی که خارج می‌شود: اجاره، خوراک، اشتراک‌ها، تفریح." },
          { type: "read", text: "قاعده طلایی ساده است: کمتر از درآمدت خرج کن. فاصله بین درآمد و هزینه‌ها همان «نفسِ مالی» توست." },
        ],
      },
      {
        title: "هزینه‌های ثابت و متغیر",
        content: [
          { type: "read", text: "هزینه‌های ثابت معمولاً هر ماه تقریباً یکسان‌اند: اجاره، بیمه، قسط خودرو. هزینه‌های متغیر نوسان دارند: خرید خوراک، رستوران، تفریح." },
          { type: "read", text: "وقتی تفاوت‌شان را بدانی، راحت‌تر می‌فهمی کجاها انعطاف داری و از کجا می‌توانی هزینه‌ها را کم کنی." },
        ],
      },
      {
        title: "قانون ۵۰/۳۰/۲۰",
        content: [
          { type: "read", text: "قانون ۵۰/۳۰/۲۰ یک چارچوب ساده است: ۵۰٪ برای نیازها، ۳۰٪ برای خواسته‌ها و ۲۰٪ برای پس‌انداز و پرداخت بدهی." },
          { type: "read", text: "این قانون «قانون سخت» نیست؛ فقط یک نقطه شروع است تا بفهمی نسبت هزینه‌هایت چطور است و کجا باید تنظیمش کنی." },
        ],
      },
      {
        title: "ردیابی هزینه‌ها",
        content: [
          { type: "read", text: "تا زمانی که دقیق ندانی پولت کجا می‌رود، بودجه واقعی نداری. حداقل یک ماه هزینه‌هایت را ثبت کن (حتی هزینه‌های کوچک)." },
          { type: "read", text: "بعد از چند هفته، الگوها مشخص می‌شوند: خریدهای ریز، اشتراک‌های فراموش‌شده یا هزینه‌های غیرضروری که جمع‌شان زیاد می‌شود." },
        ],
      },
      {
        title: "ساخت اولین بودجه",
        content: [
          { type: "read", text: "برای شروع، درآمد ماهانه‌ات را بنویس و بعد هزینه‌ها را به «نیاز»، «خواسته» و «پس‌انداز/بدهی» تقسیم کن." },
          { type: "read", text: "بودجه باید واقعی باشد: کمی جا برای تفریح بگذار، و هر ماه با توجه به تجربه ماه قبل آن را اصلاح کن." },
        ],
      },
    ],
    "پس‌انداز و صندوق اضطراری": [
      {
        title: "چرا پس‌انداز کنیم؟",
        content: [
          { type: "read", text: "پس‌انداز فقط برای «روز مبادا» نیست؛ برای آزادی انتخاب است: آرامش، فرصت‌های بهتر و توانایی رسیدن به اهداف." },
          { type: "read", text: "حتی پس‌اندازهای کوچک هم مهم‌اند؛ چون عادت می‌سازند و در بلندمدت جمع می‌شوند." },
        ],
      },
      {
        title: "اول به خودت پرداخت کن",
        content: [
          { type: "read", text: "«اول به خودت پرداخت کن» یعنی قبل از اینکه پولت خرج شود، بخشی از درآمد را همان اول کنار بگذاری." },
          { type: "read", text: "با انتقال خودکار به حساب پس‌انداز، تصمیم‌گیری سخت‌تر را حذف می‌کنی و احتمال موفقیتت بالا می‌رود." },
        ],
      },
      {
        title: "مبانی صندوق اضطراری",
        content: [
          { type: "read", text: "صندوق اضطراری برای هزینه‌های غیرمنتظره است: تعمیر خودرو، هزینه درمان، از دست دادن شغل و…" },
          { type: "read", text: "هدف رایج، ۳ تا ۶ ماه هزینه‌های ضروری است؛ اما حتی شروع با ۱ ماه هم خیلی بهتر از هیچ است." },
        ],
      },
      {
        title: "پس‌انداز را کجا نگه داریم؟",
        content: [
          { type: "read", text: "پس‌انداز کوتاه‌مدت را جایی نگه دار که هم امن باشد و هم سریع قابل دسترس: حساب سپرده/پس‌انداز یا گزینه‌های کم‌ریسک." },
          { type: "read", text: "پول صندوق اضطراری را وارد سرمایه‌گذاری‌های پرنوسان نکن؛ چون ممکن است دقیقاً وقتی نیاز داری، ارزشش پایین آمده باشد." },
        ],
      },
      {
        title: "راهکارهای پس‌انداز",
        content: [
          { type: "read", text: "راهکارهای ساده: کاهش هزینه‌های ثابت، حذف اشتراک‌های اضافی و محدود کردن خریدهای هیجانی." },
          { type: "read", text: "از روش‌های کوچک شروع کن: کنار گذاشتن درصد ثابت از هر درآمد یا انتقال خودکار ماهانه." },
        ],
      },
      {
        title: "هدف‌گذاری برای پس‌انداز",
        content: [
          { type: "read", text: "هدف‌گذاری یعنی مشخص کردن «چقدر» و «تا چه زمانی». هدف مبهم مثل «می‌خوام بیشتر پس‌انداز کنم» معمولاً شکست می‌خورد." },
          { type: "read", text: "هدف را به قدم‌های کوچک تبدیل کن: ماهانه/هفتگی. و رسیدن به مرحله‌ها را جشن بگیر تا انگیزه بماند." },
        ],
      },
    ],
    "مبانی بدهی و اعتبار": [
      {
        title: "درک بدهی",
        content: [
          { type: "read", text: "بدهی یعنی امروز چیزی را می‌خری و در آینده با بهره یا کارمزد پس می‌دهی. بعضی بدهی‌ها مفیدند (مثل وام مسکن)، بعضی خطرناک (بدهی با بهره بالا)." },
          { type: "read", text: "کلید مدیریت بدهی این است: نرخ بهره، زمان بازپرداخت و اینکه بدهی چه ارزش واقعی‌ای برایت ایجاد می‌کند." },
        ],
      },
      {
        title: "بهره چگونه کار می‌کند؟",
        content: [
          { type: "read", text: "بهره هزینه قرض گرفتن پول است. هرچه نرخ بهره بالاتر و مدت بازپرداخت طولانی‌تر باشد، پول بیشتری پرداخت می‌کنی." },
          { type: "read", text: "اگر فقط حداقل پرداخت را انجام بدهی، ممکن است بدهی مدت‌ها باقی بماند و بخش زیادی از پرداخت‌ها صرف بهره شود." },
        ],
      },
      {
        title: "امتیاز اعتباری چیست؟",
        content: [
          { type: "read", text: "امتیاز اعتباری یک شاخص برای سنجش خوش‌حسابی است. پرداخت به‌موقع، میزان استفاده از اعتبار و سابقه حساب‌ها روی آن اثر می‌گذارند." },
          { type: "read", text: "امتیاز بهتر یعنی احتمال دریافت وام با شرایط بهتر بیشتر می‌شود. مهم‌ترین کار: دیرکرد نداشتن." },
        ],
      },
      {
        title: "روش گلوله‌برفی بدهی",
        content: [
          { type: "read", text: "روش گلوله‌برفی یعنی اول کوچک‌ترین بدهی را سریع تسویه می‌کنی، بعد پول آزادشده را برای بدهی بعدی می‌گذاری." },
          { type: "read", text: "این روش از نظر روانی خیلی انگیزه‌دهنده است، چون سریع «موفقیت‌های کوچک» می‌بینی." },
        ],
      },
      {
        title: "روش بهمن بدهی",
        content: [
          { type: "read", text: "روش بهمن یعنی اول بدهی با بالاترین نرخ بهره را هدف می‌گیری، چون بیشترین هزینه را ایجاد می‌کند." },
          { type: "read", text: "از نظر ریاضی معمولاً سریع‌تر و ارزان‌تر تمام می‌شود، ولی شاید انگیزه‌اش کمی سخت‌تر باشد." },
        ],
      },
      {
        title: "استفاده هوشمندانه از اعتبار",
        content: [
          { type: "read", text: "اعتبار می‌تواند ابزار باشد، نه دام. اگر می‌خواهی از اعتبار استفاده کنی، برنامه داشته باش و توان پرداخت را قبلش بسنج." },
          { type: "read", text: "قاعده امن: اگر نمی‌توانی صورت‌حساب را کامل و به‌موقع پرداخت کنی، باید هزینه را کم کنی یا راه دیگری پیدا کنی." },
        ],
      },
    ],
    "مبانی سرمایه‌گذاری": [
      {
        title: "چرا سرمایه‌گذاری کنیم؟",
        content: [
          { type: "read", text: "پس‌انداز برای کوتاه‌مدت خوب است، اما برای اهداف بلندمدت معمولاً سرمایه‌گذاری لازم است تا از تورم جا نمانی." },
          { type: "read", text: "سرمایه‌گذاری یعنی پولت را در دارایی‌هایی می‌گذاری که احتمالاً در زمان رشد می‌کنند
